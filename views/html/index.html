<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Whatsapp</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="css/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" href="css/style.css">
  <style>

  </style>
</head>

<body class="fixed-sn white-skin chat-page">
  <div id="body">
    <!-- Main Navigation -->
    <header>
      <!-- Navbar -->
      <nav class="navbar fixed-top navbar-expand-lg scrolling-navbar double-nav">

        <!-- SideNav slide-out button -->
        <div class="float-left">
          <a href="#" data-activates="slide-out" class="button-collapse"><i class="fas fa-bars"></i></a>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb-dn mr-auto">
          <p>Chat</p>
        </div>

        <!-- Navbar links -->
        <ul class="nav navbar-nav nav-flex-icons ml-auto">
          <!-- Dropdown -->
          <li class="nav-item dropdown notifications-nav">
            <a class="nav-link dropdown-toggle waves-effect" id="navbarDropdownMenuLink" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              <span class="badge red">3</span> <i class="fas fa-bell"></i>
              <span class="d-none d-md-inline-block">Notifications</span>
            </a>
            <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="#">
                <i class="far fa-money-bill-alt mr-2" aria-hidden="true"></i>
                <span>New order received</span>
                <span class="float-right"><i class="far fa-clock" aria-hidden="true"></i> 13 min</span>
              </a>
              <a class="dropdown-item" href="#">
                <i class="far fa-money-bill-alt mr-2" aria-hidden="true"></i>
                <span>New order received</span>
                <span class="float-right"><i class="far fa-clock" aria-hidden="true"></i> 33 min</span>
              </a>
              <a class="dropdown-item" href="#">
                <i class="fas fa-chart-line mr-2" aria-hidden="true"></i>
                <span>Your campaign is about to end</span>
                <span class="float-right"><i class="far fa-clock" aria-hidden="true"></i> 53 min</span>
              </a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link waves-effect"><i class="fas fa-envelope"></i> <span
                class="clearfix d-none d-sm-inline-block">Contact</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link waves-effect"><i class="far fa-comments"></i> <span
                class="clearfix d-none d-sm-inline-block">Support</span></a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle waves-effect" href="#" id="userDropdown" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-user"></i> <span class="clearfix d-none d-sm-inline-block">Profile</span>
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
              <a class="dropdown-item" href="#">Log Out</a>
              <a class="dropdown-item" href="#">My account</a>
            </div>
          </li>

        </ul>
        <!-- Navbar links -->
      </nav>
      <!-- Navbar -->
    </header>
    <!-- Main Navigation -->

    <!-- Main layout -->
    <main class="m-0 px-5">
      <div class="container-fluid">
        <!-- Section: Chat -->
        <section>
          <!-- Grid row -->
          <div class="row">
            <!-- Grid column -->
            <div class="col-lg-4">
              <!-- Name -->
              <div class="md-form mb-4">
                <i class="fas fa-search prefix"></i>
                <input type="text" id="searchConv" class="form-control">
                <label for="searchConv" class="">Search Contacts</label>
              </div>

              <!-- Messages -->
              <div class="list-group" id="listContacts">
                <!-- Single message -->
              </div>
              <!-- Messages -->
            </div>
            <!-- Grid column -->

            <!-- Grid column -->
            <div class="col-lg-8 mt-lg-0 my-5">
              <!-- Conversation -->
              <div class="border-left p-4" id="listMessages">
              </div>
              <div class="d-flex flex-row">
                <div class="md-form chat-message-type">
                  <input type="hidden" id="toClientNumber" name="number">
                  <textarea type="text" id="elMessage" name="message" class="md-textarea form-control"
                    rows="3"></textarea>
                  <label for="form7">Type your message</label>
                </div>
                <div class="mt-5">
                  <button id="sendMessage" class="btn btn-primary btn-lg waves-effect waves-light">Send</button>
                </div>
              </div>
              <!-- Conversation -->
            </div>
            <!-- Grid column -->
          </div>
          <!-- Grid row -->
        </section>
        <!-- Section: Chat -->
      </div>
    </main>
    <!-- Main layout -->
  </div>

  <div class="container h-100">
    <div class="row h-100 justify-content-center align-items-center">
      <div class="col-md-3 text-center">
        <img src="#" id="qrcode" alt="Qr Code">
        <ul class="logs p-0 mt-2">
        </ul>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <!-- JQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
    integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
    crossorigin="anonymous"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.js"
    integrity="sha512-+l9L4lMTFNy3dEglQpprf7jQBhQsQ3/WvOnjaN/+/L4i0jOstgScV0q2TjfvRF4V+ZePMDuZYIQtg5T4MKr+MQ=="
    crossorigin="anonymous"></script>

  <!-- Custom scripts -->

  <script>
    $(document).ready(function () {
      var socket = io.connect('http://localhost:8000', {
        path: '/socket.io'
      });

      // others Function
      function convertTimestamp(timestamp) {
        let date = new Date(timestamp * 1000),
          datevalues = [
            date.getFullYear(),
            date.getMonth() + 1,
            date.getDate(),
            date.getHours(),
            date.getMinutes(),
            date.getSeconds(),
          ];

        return datevalues
      }
      //==============================//

      // Function getListsContact
      function listsContact(contacts, listContacts) {
        contacts.forEach(c => {
          // create 
          const a = document.createElement('a')
          a.classList.add('list-group-item', 'list-group-item-action', 'media', 'contactClass')
          // create img
          const img = document.createElement('img')
          img.setAttribute('src', 'https://mdbootstrap.com/img/Photos/Avatars/img (32).jpg')
          img.classList.add('mr-3', 'avatar-sm', 'float-left')

          a.append(img)

          // // create div for name and date
          const divNameDate = document.createElement('div')
          divNameDate.classList.add('d-flex', 'justify-content-between', 'mb-1')

          a.append(divNameDate)

          const contactName = document.createElement('hp')
          contactName.classList.add('mb-1', 'font-weight-bold')

          divNameDate.append(contactName)

          const contactDate = document.createElement('small')
          contactDate.innerText = c.number
          divNameDate.append(contactDate)
          const contactChat = document.createElement('p')
          if (typeof c.name !== 'undefined') {
            contactChat.innerText = c.name
          } else {
            contactChat.innerText = c.number
          }
          contactChat.classList.add('text-truncate', 'font-weight-bold')
          a.append(contactChat)
          listContacts.append(a);
        });
        return true;
      }

      // Function getMessagesFromContact
      function getMessages(chat, listMessages) {
        const divDate = document.createElement('div')
        divDate.classList.add('small', 'text-center')
        listMessages.append(divDate)
        const divMessages = document.createElement('div')
        const pMessages = document.createElement('p')

        if (!chat.fromMe) {
          divMessages.classList.add('d-flex', 'justify-content-start', 'media')
          const img = document.createElement('img')
          img.setAttribute('src', 'https://mdbootstrap.com/img/Photos/Avatars/img (32).jpg')
          img.classList.add('mr-3', 'avatar-sm', 'float-left')
          pMessages.classList.add('grey', 'lighten-3', 'p-3', 'w-75')
          divMessages.append(img)
        } else {
          divMessages.classList.add('d-flex', 'justify-content-end')
          pMessages.classList.add('primary-color', 'rounded', 'p-3', 'text-white', 'w-75',
            'text-right')
        }

        let valDate = convertTimestamp(chat.timestamp)
        let year = valDate[0]
        let month = valDate[1]
        let tanggal = valDate[2]
        let hour = valDate[3]
        let minute = valDate[4]
        let seconds = valDate[5]

        divDate.innerText = year + '-' + month + '-' + tanggal + ' ' + hour + ':' + minute + ':' + seconds
        if (chat.hasMedia) {
          pMessages.innerText = chat.mediaKey
        } else {
          pMessages.innerText = chat.body
        }
        divMessages.append(pMessages)
        listMessages.append(divMessages)
      }

      const toNumberClient = document.querySelector('#toClientNumber')
      const elMessage = document.querySelector('#elMessage')
      const btnSend = document.querySelector('#sendMessage')

      function sendMessage(vNumber, vMessage) {
        $.ajax({
          type: 'POST',
          url: 'http://localhost:8000/send-message',
          data: {
            'number': vNumber,
            'message': vMessage
          },
          success: function (msg) {
            alert('Terkirim')
            elMessage.value = ''
          }
        });
      }
      btnSend.addEventListener('click', function () {
        const vNumber = toNumberClient.value
        const vMessage = elMessage.value
        sendMessage(vNumber, vMessage);
      })

      const listMessages = document.querySelector('#listMessages')
      socket.on('contacts', async function (contacts) {
        const listContacts = document.querySelector('#listContacts');
        const getContact = await listsContact(contacts, listContacts)
        if (getContact) {
          let aContacts = Array.from(document.getElementsByClassName('contactClass'))
          aContacts.forEach(function (aContact) {
            aContact.addEventListener('click', function () {
              listMessages.innerHTML = '';
              const cArray = Array.from(this.childNodes);
              console.log(cArray);
              const number = cArray[1].innerText;
              const idContact = number + '@c.us'
              console.log();
              socket.emit("idContact", {
                idContact: idContact,
                number: number
              });
            })
          })
        }
      })

      socket.on('pesan', async function (chats) {
        toNumberClient.value = chats.number
        if (chats.message) {
          chats.message.forEach((chat) => {
            getMessages(chat, listMessages)
          })
        } else {
          console.log('Belum ada chat dengan nomor ini');
        }
      })

      socket.on('message', function (msg) {
        console.log(msg);
        $('.logs').append($('<li>').text(msg));
      });

      socket.on('qr', function (src) {
        $('#qrcode').attr('src', src);
        $('#qrcode').show();
      });

      const body = document.querySelector('#body')
      socket.on('ready', function (src) {
        $('#qrcode').hide();
        $('.logs').hide();
        body.style.display = "block"
      });

      socket.on('authenticated', function (src) {
        $('#qrcode').hide();
        $('.logs').hide();
        body.style.display = "block"
      });
    });
  </script>

</body>

</html>